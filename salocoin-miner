#!/usr/bin/env python3
"""
SALOCOIN Miner CLI
Usage: salocoin-miner <command> [options]
"""

import sys
import os
import time
import argparse
import json
import signal

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import config
from core.wallet import Wallet
from core.blockchain import Blockchain, Block
from core.transaction import Transaction
from sync import BlockchainSync

# Seed node configuration
SEED_NODE = "https://api.salocoin.org"

# Directories
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
WALLETS_DIR = os.path.join(BASE_DIR, 'wallets')
DATA_DIR = os.path.join(BASE_DIR, 'data')
MINER_CONFIG = os.path.join(DATA_DIR, 'miner.json')

os.makedirs(DATA_DIR, exist_ok=True)

SALO = config.COIN_UNIT

# Global state
running = True


def signal_handler(sig, frame):
    global running
    running = False
    print("\n\nâ¹ï¸  Stopping miner...")


def load_miner_config() -> dict:
    if os.path.exists(MINER_CONFIG):
        with open(MINER_CONFIG, 'r') as f:
            return json.load(f)
    return {'address': None, 'blocks_mined': 0, 'total_reward': 0}


def save_miner_config(cfg: dict):
    with open(MINER_CONFIG, 'w') as f:
        json.dump(cfg, f, indent=2)


def mine_block(blockchain: Blockchain, miner_address: str) -> Block:
    """Mine a single block."""
    global running
    
    latest = blockchain.get_latest_block()
    height = latest.height + 1
    
    # Create coinbase transaction
    coinbase = Transaction.create_coinbase(
        block_height=height,
        miner_address=miner_address,
        extra_data=f"SALOCOIN Miner - Block {height}"
    )
    
    # Get pending transactions from mempool
    transactions = [coinbase.to_dict()]
    mempool_txs = blockchain.mempool.get_transactions(max_count=100)
    for tx in mempool_txs:
        transactions.append(tx.to_dict())
    
    # Create block
    block = Block(
        version=1,
        height=height,
        timestamp=int(time.time()),
        previous_hash=latest.hash,
        merkle_root='',
        difficulty=blockchain.current_difficulty,
        nonce=0,
        transactions=transactions,
    )
    block.merkle_root = block.calculate_merkle_root()
    
    # Mining
    target = Block.get_target_from_difficulty(block.difficulty)
    start_time = time.time()
    
    mempool_count = len(transactions) - 1  # Exclude coinbase
    print(f"\nâ›ï¸  Mining block {height}...")
    print(f"   Transactions: {len(transactions)} ({mempool_count} from mempool)")
    
    # Show pending transactions that will be confirmed
    if mempool_count > 0:
        print(f"   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"   ğŸ“¨ Pending TXs to confirm:")
        for tx in mempool_txs[:10]:  # Show max 10
            tx_dict = tx.to_dict()
            total_out = sum(o.get('amount', 0) for o in tx_dict.get('outputs', []))
            to_addr = tx_dict.get('outputs', [{}])[0].get('address', '')[:16] if tx_dict.get('outputs') else ''
            print(f"      â†’ {tx.txid[:16]}... {total_out / SALO:.4f} SALO â†’ {to_addr}...")
        if mempool_count > 10:
            print(f"      ... and {mempool_count - 10} more")
        print(f"   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
    
    nonce = 0
    while running:
        block.nonce = nonce
        block.hash = block.calculate_hash()
        
        if int(block.hash, 16) < target:
            elapsed = time.time() - start_time
            hashrate = nonce / elapsed if elapsed > 0 else 0
            print(f"   âœ“ Block found!")
            print(f"   Hash: {block.hash[:32]}...")
            print(f"   Nonce: {nonce:,}")
            print(f"   Time: {elapsed:.2f}s")
            print(f"   Hashrate: {hashrate/1000:.2f} KH/s")
            return block
        
        nonce += 1
        if nonce % 500000 == 0:
            elapsed = time.time() - start_time
            hashrate = nonce / elapsed if elapsed > 0 else 0
            print(f"   ... {nonce:,} hashes ({hashrate/1000:.2f} KH/s)")
    
    return None


def cmd_start(args):
    """Start mining."""
    global running
    running = True
    signal.signal(signal.SIGINT, signal_handler)
    
    cfg = load_miner_config()
    
    # Get mining address
    if args.address:
        miner_address = args.address
    elif cfg['address']:
        miner_address = cfg['address']
    else:
        # Try default wallet
        default_wallet = os.path.join(WALLETS_DIR, 'default.json')
        if os.path.exists(default_wallet):
            wallet = Wallet(filepath=default_wallet)
            wallet.load()
            miner_address = wallet.addresses[0].address
        else:
            print("Error: No mining address set.")
            print("Use: salocoin-miner set-address <address>")
            print("Or create a default wallet: salocoin-wallet create default")
            sys.exit(1)
    
    cfg['address'] = miner_address
    save_miner_config(cfg)
    
    # Load blockchain
    blockchain = Blockchain(data_dir=DATA_DIR)
    
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   SALOCOIN Miner                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
    print(f"Mining Address: {miner_address}")
    
    # Sync from seed node
    syncer = None
    if not args.nosync:
        print(f"\nğŸ”„ Syncing from seed node ({SEED_NODE})...")
        try:
            syncer = BlockchainSync(blockchain, seed_url=SEED_NODE)
            status = syncer.get_status()
            if status:
                print(f"   Seed node height: {status.get('height', 0)}")
                print(f"   Genesis: {status.get('genesis', '')[:32]}...")
                syncer.sync_from_seed()
                print(f"   âœ“ Synced to height {blockchain.get_height()}")
            else:
                print(f"   âš  Seed node not reachable")
                print(f"   Mining from local chain...")
        except Exception as e:
            print(f"   âš  Sync failed: {e}")
            print(f"   Mining from local chain...")
    
    # Validate genesis block
    if not blockchain.validate_genesis():
        print("âŒ INVALID GENESIS BLOCK!")
        print("   Your blockchain data is corrupted or from a different network.")
        print("   Delete the data/ folder and restart to sync from seed node.")
        sys.exit(1)
    
    print(f"\nBlockchain Height: {blockchain.get_height()}")
    print(f"Block Reward: {config.calculate_block_reward(blockchain.get_height() + 1) / SALO} SALO")
    print(f"Seed Node: {'Connected' if syncer else 'Disabled'}")
    print(f"\nPress Ctrl+C to stop mining.\n")
    
    blocks_mined = 0
    total_reward = 0
    
    while running:
        # Re-sync before each block to get latest chain and mempool
        if syncer:
            try:
                syncer.sync_from_seed()
                syncer.sync_mempool()  # Sync pending transactions from network
            except:
                pass
        
        block = mine_block(blockchain, miner_address)
        
        if block and blockchain.add_block(block):
            reward = config.calculate_block_reward(block.height)
            blocks_mined += 1
            total_reward += reward
            
            cfg['blocks_mined'] = cfg.get('blocks_mined', 0) + 1
            cfg['total_reward'] = cfg.get('total_reward', 0) + reward
            save_miner_config(cfg)
            
            print(f"   ğŸ’° Reward: {reward / SALO} SALO")
            print(f"   ğŸ“Š Total mined: {total_reward / SALO} SALO ({blocks_mined} blocks)")
            
            # Submit block to seed node
            if syncer:
                try:
                    if syncer.submit_block(block):
                        print(f"   ğŸ“¡ Block submitted to network")
                    else:
                        # Block rejected - someone else found a block first
                        print(f"   âŒ Block rejected by network!")
                        blocks_mined -= 1
                        total_reward -= reward
                        cfg['blocks_mined'] = cfg.get('blocks_mined', 0) - 1
                        cfg['total_reward'] = cfg.get('total_reward', 0) - reward
                        save_miner_config(cfg)
                        try:
                            syncer.resync_chain()
                            print(f"   âœ“ Chain resynced to height {blockchain.get_height()}")
                        except Exception as e:
                            print(f"   âš  Resync failed: {e}")
                except Exception as e:
                    print(f"   âš  Failed to submit: {e}")
                    try:
                        syncer.resync_chain()
                    except:
                        pass
            
            # Save periodically
            if blocks_mined % 5 == 0:
                blockchain.save()
                print(f"   ğŸ’¾ Blockchain saved")
    
    # Final save
    blockchain.save()
    
    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   Mining Summary                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Blocks Mined: {blocks_mined:<41} â•‘
â•‘  Total Reward: {total_reward / SALO:<38} SALO â•‘
â•‘  Blockchain Height: {blockchain.get_height():<35} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")


def cmd_status(args):
    """Show miner status."""
    cfg = load_miner_config()
    blockchain = Blockchain(data_dir=DATA_DIR)
    blockchain.load()
    
    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   Miner Status                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Mining Address: {cfg.get('address', 'Not set')}
Total Blocks Mined: {cfg.get('blocks_mined', 0)}
Total Rewards: {cfg.get('total_reward', 0) / SALO} SALO
Blockchain Height: {blockchain.get_height()}
Current Difficulty: {blockchain.current_difficulty}
""")


def cmd_set_address(args):
    """Set mining address."""
    cfg = load_miner_config()
    cfg['address'] = args.address
    save_miner_config(cfg)
    print(f"\nâœ“ Mining address set to: {args.address}\n")


def main():
    parser = argparse.ArgumentParser(
        prog='salocoin-miner',
        description='SALOCOIN Miner'
    )
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # start
    p = subparsers.add_parser('start', help='Start mining')
    p.add_argument('--address', '-a', help='Mining address')
    p.add_argument('--nosync', action='store_true', help='Disable seed node sync')
    
    # status
    subparsers.add_parser('status', help='Show miner status')
    
    # set-address
    p = subparsers.add_parser('set-address', help='Set mining address')
    p.add_argument('address', help='Wallet address')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    commands = {
        'start': cmd_start,
        'status': cmd_status,
        'set-address': cmd_set_address,
    }
    
    commands[args.command](args)


if __name__ == '__main__':
    main()
